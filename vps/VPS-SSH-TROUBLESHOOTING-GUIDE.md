# VPS SSH Troubleshooting Guide

## Quick Reference
- **VPS IP**: 168.231.74.29
- **VPS IPv6**: 2a02:4780:2d:cc43::1
- **Hostname**: srv896342.hstgr.cloud
- **SSH Key**: ~/.ssh/id_rsa_vps
- **Config Entry**: ghost-vps

## üöÄ Quick Commands

### Test & Auto-Fix
```bash
vps test                    # Test connection with auto-fix
vps ssh-fix                 # Run comprehensive SSH setup
vps ssh-backup              # Backup SSH configurations
bash ssh-vps-setup.sh       # Full SSH reconfiguration
```

### Direct SSH Access
```bash
ssh ghost-vps               # Primary method
ssh root@168.231.74.29      # Direct IP
ssh -p 2222 root@168.231.74.29  # Alternate port
~/vps-connect.sh            # Auto-retry script
```

## üîß Common Issues & Solutions

### 1. "Permission denied (publickey)"
```bash
# Fix permissions
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_rsa_vps
chmod 644 ~/.ssh/id_rsa_vps.pub
chmod 600 ~/.ssh/config

# Verify key exists
ls -la ~/.ssh/id_rsa_vps*
```

### 2. "Host key verification failed"
```bash
# Remove old host keys
ssh-keygen -R 168.231.74.29
ssh-keygen -R srv896342.hstgr.cloud
ssh-keygen -R 2a02:4780:2d:cc43::1

# Connect with auto-accept
ssh -o StrictHostKeyChecking=accept-new ghost-vps
```

### 3. "Connection timed out"
```bash
# Test network connectivity
ping -c 4 168.231.74.29

# Test specific ports
nc -zv 168.231.74.29 22
nc -zv 168.231.74.29 2222

# Try alternate connection methods
ssh -4 ghost-vps            # Force IPv4
ssh -6 ghost-vps-ipv6       # Force IPv6
ssh -p 2222 ghost-vps-alt   # Alternate port
```

### 4. "Connection refused"
```bash
# SSH service might be down
# Use VPS provider's web console to:
sudo systemctl status ssh
sudo systemctl restart ssh

# Check firewall
sudo ufw status
sudo ufw allow 22/tcp
```

### 5. Control Socket Issues
```bash
# Clear stale control sockets
rm -f ~/.ssh/master-*

# Connect without multiplexing
ssh -o ControlPath=none ghost-vps
```

## üìã Diagnostic Commands

### Full Connection Test
```bash
ssh -vvv ghost-vps exit 2>&1 | grep -E "(debug1|Connecting|Host key|Authentication)"
```

### Check SSH Config
```bash
# View active configuration
ssh -G ghost-vps | grep -E "(hostname|port|user|identityfile)"

# Test config syntax
ssh -G ghost-vps >/dev/null && echo "Config OK" || echo "Config Error"
```

### Network Diagnostics
```bash
# Traceroute to VPS
traceroute 168.231.74.29

# MTU discovery
ping -c 4 -s 1472 -D 168.231.74.29

# DNS resolution
nslookup srv896342.hstgr.cloud
```

## üõ†Ô∏è Manual Recovery Steps

### Step 1: Basic Connectivity
```bash
# Can you reach the VPS?
ping -c 4 168.231.74.29

# Is SSH port open?
telnet 168.231.74.29 22
```

### Step 2: Direct SSH Test
```bash
# Try simplest connection
ssh -o PreferredAuthentications=publickey \
    -o PasswordAuthentication=no \
    -i ~/.ssh/id_rsa_vps \
    root@168.231.74.29
```

### Step 3: Fix SSH Config
```bash
# Backup current config
cp ~/.ssh/config ~/.ssh/config.backup

# Create minimal config
cat > ~/.ssh/config.minimal << EOF
Host ghost-vps
    HostName 168.231.74.29
    User root
    IdentityFile ~/.ssh/id_rsa_vps
    IdentitiesOnly yes
EOF

# Test minimal config
ssh -F ~/.ssh/config.minimal ghost-vps
```

### Step 4: Key Verification
```bash
# Check if your key is on the VPS
# (Use provider's web console)
cat ~/.ssh/authorized_keys | grep "$(cat ~/.ssh/id_rsa_vps.pub | awk '{print $2}')"

# If missing, add it:
echo "$(cat ~/.ssh/id_rsa_vps.pub)" >> ~/.ssh/authorized_keys
```

## üîê Security Best Practices

### On Your Local Machine
```bash
# Regular maintenance
bash vps-ssh-maintenance.sh

# Keep backups
ls -la ~/.ssh/backups/
```

### On the VPS
```bash
# Apply secure SSH config
scp sshd_config_secure ghost-vps:/etc/ssh/sshd_config
ssh ghost-vps "systemctl restart sshd"

# Regular updates
ssh ghost-vps "apt update && apt upgrade -y"
```

## üì± Emergency Access

If SSH completely fails:

1. **VPS Provider Console**
   - Log into your VPS provider's control panel
   - Use web-based console/VNC access
   - Fix SSH from inside the VPS

2. **Recovery Mode**
   - Boot VPS in recovery mode
   - Mount filesystem and fix SSH keys
   - Reset SSH configuration

3. **Support Ticket**
   - Contact VPS provider support
   - Request SSH service check
   - Ask for firewall verification

## üîÑ Automated Scripts

### ssh-vps-setup.sh
- Tests all connection methods
- Auto-configures SSH settings
- Creates fallback options
- Updates SSH config

### vps-ssh-maintenance.sh
- Backs up configurations
- Fixes permissions
- Cleans known_hosts
- Creates aliases

### vps-connect.sh
- Auto-generated by setup
- Tries multiple connection methods
- Falls back on failure
- Runs diagnostics if needed

## üìä Connection Status Check

```bash
# One-liner status check
ssh -o ConnectTimeout=5 ghost-vps "echo '‚úÖ SSH OK' && uptime" || echo "‚ùå SSH Failed"
```

## üéØ Quick Win Commands

```bash
# The "usually works" fix
chmod 600 ~/.ssh/id_rsa_vps && ssh-keygen -R 168.231.74.29 && ssh ghost-vps

# The "reset everything" fix
rm -f ~/.ssh/known_hosts ~/.ssh/master-* && bash ssh-vps-setup.sh

# The "I need in NOW" connection
ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@168.231.74.29
```

## üìù Maintenance Schedule

- **Daily**: Use `vps status` to check connectivity
- **Weekly**: Run `vps ssh-backup` 
- **Monthly**: Review and clean old backups
- **Issues**: Run `vps ssh-fix` immediately

---

Last Updated: $(date)
Location: ~/DevOps/_project_folders/seftechub-workspace/VPS-SSH-TROUBLESHOOTING-GUIDE.md