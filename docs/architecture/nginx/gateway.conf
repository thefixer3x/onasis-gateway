# Unified Nginx Gateway (reference configuration)
# Note: maps/limit_req_zone/log_format must live in the http context (nginx.conf).

http {
    # === UPSTREAMS ===
    upstream central_gateway {
        server 127.0.0.1:3000;
        keepalive 64;
    }

    upstream auth_gateway {
        server 127.0.0.1:4000;
        keepalive 32;
    }

    upstream enterprise_mcp {
        server 127.0.0.1:3001;
        keepalive 16;
    }

    upstream mcp_core_http {
        server 127.0.0.1:3001;
        keepalive 32;
    }

    upstream mcp_core_ws {
        server 127.0.0.1:3002;
        keepalive 16;
    }

    upstream mcp_core_sse {
        server 127.0.0.1:3003;
        keepalive 16;
    }

    # === LOGGING ===
    log_format gateway_json escape=json '{'
        '"timestamp":"$time_iso8601",'
        '"request_id":"$request_id",'
        '"client_ip":"$remote_addr",'
        '"method":"$request_method",'
        '"uri":"$uri",'
        '"status":$status,'
        '"bytes":$body_bytes_sent,'
        '"response_time":$request_time,'
        '"upstream":"$upstream_addr",'
        '"user_agent":"$http_user_agent"'
    '}';

    # === RATE LIMITING ZONES ===
    limit_req_zone $binary_remote_addr zone=general:10m rate=20r/s;
    limit_req_zone $binary_remote_addr zone=auth:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=api:10m rate=50r/s;
    limit_conn_zone $binary_remote_addr zone=ws_conn:10m;

    # === CORS ORIGIN WHITELIST ===
    map $http_origin $cors_origin {
        default "";
        "https://app.lanonasis.com" $http_origin;
        "https://dashboard.lanonasis.com" $http_origin;
        "https://admin.lanonasis.com" $http_origin;
        "https://gateway.lanonasis.com" $http_origin;
        "https://api.landonnet.com" $http_origin;
        "https://mcp.lanonasis.com" $http_origin;
        "https://mcp1.lanonasis.com" $http_origin;
        "http://localhost:3000" $http_origin;
        "http://localhost:5173" $http_origin;
        "http://127.0.0.1:3000" $http_origin;
    }

    map $request_method $cors_preflight {
        default 0;
        OPTIONS 1;
    }

    server {
        listen 443 ssl http2;
        server_name gateway.lanonasis.com api.landonnet.com;

        # === SSL CONFIGURATION ===
        ssl_certificate /etc/letsencrypt/live/gateway.lanonasis.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/gateway.lanonasis.com/privkey.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers off;

        # === SECURITY HEADERS ===
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # === LOGGING ===
        access_log /var/log/nginx/gateway_access.json gateway_json;
        error_log /var/log/nginx/gateway_error.log warn;

        # === GLOBAL CORS ===
        add_header 'Access-Control-Allow-Origin' '$cors_origin' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Request-ID, X-API-Key' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;

        if ($cors_preflight) {
            add_header 'Access-Control-Allow-Origin' '$cors_origin';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Request-ID, X-API-Key';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Max-Age' 86400;
            add_header 'Content-Length' 0;
            return 204;
        }

        # === REQUEST ID TRACKING ===
        add_header 'X-Request-ID' $request_id always;

        # === HEALTH ===
        location /health {
            proxy_pass http://central_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location /health/full {
            proxy_pass http://central_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        # === AUTH GATEWAY ===
        location /v1/auth/ {
            limit_req zone=auth burst=20 nodelay;
            proxy_pass http://auth_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location /api/v1/auth/ {
            limit_req zone=auth burst=20 nodelay;
            proxy_pass http://auth_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location /oauth/ {
            proxy_pass http://auth_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        # OAuth discovery + well-known metadata
        location /.well-known/ {
            proxy_pass http://auth_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location /web/ {
            proxy_pass http://auth_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location /admin/ {
            proxy_pass http://auth_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location /mcp/ {
            proxy_pass http://auth_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location = /auth/cli-login {
            proxy_pass http://auth_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location = /register {
            proxy_pass http://auth_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        # === MCP CORE ===
        location /ws {
            limit_conn ws_conn 10;
            proxy_pass http://mcp_core_ws;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Request-ID $request_id;
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
        }

        location /mcp/ws {
            limit_conn ws_conn 10;
            proxy_pass http://mcp_core_ws;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Request-ID $request_id;
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
        }

        location /sse {
            proxy_pass http://mcp_core_sse;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Request-ID $request_id;
            proxy_buffering off;
            proxy_cache off;
            chunked_transfer_encoding off;
            proxy_read_timeout 3600s;
        }

        location /api/v1/events {
            proxy_pass http://mcp_core_sse;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Request-ID $request_id;
            proxy_buffering off;
            proxy_cache off;
            chunked_transfer_encoding off;
            proxy_read_timeout 3600s;
        }

        # === ENTERPRISE MCP ===
        location /api/mcp/enterprise/ {
            proxy_pass http://enterprise_mcp;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        # === MAAS ROUTES (CENTRAL GATEWAY ADAPTERS) ===
        location /api/v1/memory/ {
            limit_req zone=api burst=50 nodelay;
            proxy_pass http://central_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location /api/v1/memories/ {
            limit_req zone=api burst=50 nodelay;
            proxy_pass http://central_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location /api/v1/intelligence/ {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://central_gateway;
            proxy_read_timeout 120s;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location /api/v1/keys/ {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://central_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location /api/v1/projects/ {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://central_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location /api/v1/config/ {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://central_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location /api/v1/org {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://central_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location /api/v1/organization {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://central_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location /api/v1/auth/status {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://central_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        # === CENTRAL GATEWAY ROOT ===
        location /api/adapters/ {
            proxy_pass http://central_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location /api/tools/ {
            proxy_pass http://central_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location /api/services/ {
            proxy_pass http://central_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        # Fallback for other /api/v1 paths to central gateway (adjust if needed)
        location /api/v1/ {
            proxy_pass http://central_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }

        location / {
            proxy_pass http://central_gateway;
            include /etc/nginx/snippets/proxy-headers.conf;
        }
    }

    server {
        listen 80;
        server_name gateway.lanonasis.com api.landonnet.com;
        return 301 https://$server_name$request_uri;
    }
}
